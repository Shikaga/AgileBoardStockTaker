<html>
	<head>
		<title>Agile Board Stock Taker</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no" />
		<script src="lib/react.js"></script>
		<script src="lib/jsxTransformer.js"></script>
		<script src="lib/jquery-1.11.1.min.js"></script>
		<script src="lib/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
		<link href="lib/bootstrap-3.2.0-dist/css/bootstrap.css" rel="stylesheet">

		<style>
			.number-btn {
				width: 30%
			}
		</style>
	</head>
	<body>
		<div id="main"></div>
		<script type="text/jsx">
			/** @jsx React.DOM */
			/*var ProjectLi = React.createClass({
				onClick: function() {
					this.props.onClick(this.props.project);
				},
				render: function() {
					return <li><a href="#" onClick={this.onClick}>{this.props.project.name}</a></li>
				}
			});

			var ProjectSelector = React.createClass({
				componentWillReceiveProps: function(nextProps) {
					if (nextProps.projectData && nextProps.projectData[0]) {
						this.setState({selectedProject: nextProps.projectData[0]});
					} else {
						this.setState({selectedProject: null});
					}
				},
				getInitialState: function() {
					if (this.props.projectData && this.props.projectData[0]) {
						return {selectedProject: this.props.projectData[0]}
					}
						return {selectedProject: null}
				},
				onClick: function(project) {
					if (project.name !== this.state.selectedText) {
						this.setState({
							selectedProject: project
						});
						//this.props.columnChanged(text);
					}
				},
				selectProject: function() {
					this.props.selectProject(this.state.selectedProject);
				},
				render: function() {
					var options = [];
					if (this.props.projectData) {
						this.props.projectData.forEach(function(project) {
							options.push(<ProjectLi onClick={this.onClick} project={project}></ProjectLi>);
						}.bind(this));
						return <div>
									<span className="btn-group">
										<button type="button" className="btn btn-default dropdown-toggle" data-toggle="dropdown">
											{this.state.selectedProject.name}<span className="caret"></span>
										</button>
										<ul className="dropdown-menu" role="menu">
											{options}
										</ul>
									</span>
									<div className="panel-body">
										<div className="col-xs-12 col-md-12"><button type="button" onClick={this.selectProject} className="btn btn-success btn-block">Select</button></div>
									</div>
								</div>
					} else {
						return <div>Loading...</div>
					}
				}
			});

			var ProjectPanel = React.createClass({
				selectProject: function(project) {
					this.props.selectProject(project);
				},
				render: function() {
					return <div><ProjectSelector selectProject={this.selectProject} projectData={this.props.projectData}></ProjectSelector></div>
				}
			});*/

			var LoginPanel = React.createClass({
				getInitialState: function() {
					return {
						url: "https://jira.caplin.com",
						username: "jonp",
						password: ""
					}
				},
				changeUrl: function(e) {
					this.setState({
						url: e.target.value
					});
				},
				changeUsername: function(e) {
					this.setState({
						username: e.target.value
					});
				},
				changePassword: function(e) {
					this.setState({
						password: e.target.value
					});
				},
				login: function() {
					this.props.login(this.state.url, this.state.username, this.state.password);
				},
				render: function() {
					return <div className="panel panel-default">
						<div className="panel-body">
							<div className="input-group">
								<span className="input-group-addon">Jira Url</span>
								<input type="text" onChange={this.changeUrl} value={this.state.url} class="form-control" placeholder="Jira Url"/>
							</div><br/>
							<div className="input-group">
								<span className="input-group-addon">Username</span>
								<input type="text" onChange={this.changeUsername} value={this.state.username} class="form-control" placeholder="Username"/>
							</div><br/>
							<div className="input-group">
								<span className="input-group-addon">Password</span>
								<input type="text" onChange={this.changePassword}  type="password" value={this.state.password} class="form-control" placeholder="Password"/>
							</div>
							<div className="panel-body">
								<div className="col-xs-12 col-md-12"><button type="button" onClick={this.login} className="btn btn-success btn-block">Login</button></div>
							</div>
						</div>
					</div>
				}
			});
			
			/*
			var ChangedIssuePanel = React.createClass({
				render: function() {
					return <div>{this.props.issue.issueId} - {this.props.issue.columnName}</div>
				}
			});

			var ChangedIssuesPanel = React.createClass({
				render: function() {
					if (this.props.issues) {

						var issues = [];
						this.props.issues.forEach(function(issue) {
							issues.push(<ChangedIssuePanel issue={issue}></ChangedIssuePanel>);
						});
						return <div>{issues}</div>
					} else {
						return <div></div>
					}
				}
			});

			var IdInput = React.createClass({
				render: function() {
					return <div className="input-group">
							<span className="input-group-addon">{this.props.projectKey}-</span>
							<input type="text" className="form-control" placeholder="" value={this.props.issueId}/>
						</div>

				}
			});

			var ColumnLi = React.createClass({
				onClick: function() {
					this.props.onClick(this.props.name);
				},
				render: function() {
					return <li><a href="#" onClick={this.onClick}>{this.props.name}</a></li>
				}
			});

			var ColumnSelector = React.createClass({
				getInitialState: function() {
					return {selectedText: this.props.selected}
				},
				onClick: function(text) {
					if (text !== this.state.selectedText) {
						this.setState({
							selectedText: text
						});
						this.props.columnChanged(text);
					}
				},
				render: function() {
					var optionStrings = ['Backlog', 'Development', 'Code Review', 'Awaiting Test', 'In Test', 'Done'];
					var options = [];
					optionStrings.forEach(function(optionString) {
						options.push(<ColumnLi onClick={this.onClick} name={optionString}></ColumnLi>);
					 }.bind(this));
					return <span className="btn-group">
						<button type="button" className="btn btn-default dropdown-toggle" data-toggle="dropdown">
							{this.state.selectedText}<span className="caret"></span>
						</button>
						<ul className="dropdown-menu" role="menu">
							{options}
						</ul>
					</span>
				}
			});

			var IssuePanel = React.createClass({
				getInitialState: function() {
					console.log("XXX");
					return {

					};
				},
				columnChanged: function(columnName) {
					this.props.issueChanged({issueId: this.props.issueId, columnName: columnName});
				},
				render: function() {
					if (this.props.issueId) {
						var issue = issueHandler.getIssue(this.props.issueId);
						if (issue) {
							return <div className="panel panel-default">
								<div className="panel-body">
									<span>{issue.id}</span>
									<ColumnSelector columnChanged={this.columnChanged} selected={issue.column}></ColumnSelector>
								</div>
							</div>
						} else {
							return <div></div>
						}
					} else {
						return <div></div>
					}
				}
			});

			var IssuesPanel = React.createClass({
				getInitialState: function() {
					console.log("YYY");
					return {};
				},
				render: function() {
					return <div><IssuePanel issueChanged={this.props.issueChanged} issueId={this.props.issueId}></IssuePanel></div>
				}
			});

			var NumberDiv = React.createClass({
				doneClicked: function() {
					this.props.doneClicked();
				},
				completeClicked: function() {
					this.props.completeClicked();
				},
				numberClicked:function(number) {
					this.props.numberClicked(number);
				},
				render: function() {
					var numberRows = [];
					for (var i=0; i < 3; i++) {
						var buttons = [];
						for (var j=1; j < 4; j++) {
							buttons.push(<NumberButton buttonClicked={this.numberClicked} text={i*3+j}></NumberButton>);
						}
						numberRows.push(<ButtonRow buttonClicked={this.numberClicked} buttons={buttons}></ButtonRow>);
					}
					var buttons = [];
					var zero = 0;
					buttons.push(<NumberButton buttonClicked={this.numberClicked} text={zero}></NumberButton>);
					buttons.push(<NumberButton buttonClicked={this.doneClicked} text="Done"></NumberButton>);
					buttons.push(<NumberButton buttonClicked={this.completeClicked} text="Complete"></NumberButton>);
					numberRows.push(<ButtonRow buttons={buttons}></ButtonRow>);

					return <div><div className="row">{numberRows}</div></div>;
				}
			});

			var ButtonRow = React.createClass({
				render: function() {

					return <div className="row">{this.props.buttons}</div>
				}
			});

			var NumberButton = React.createClass({
				render: function() {
					var onClick = function() {
						this.props.buttonClicked(this.props.text);
					}.bind(this);
					var style = {
						height: "10%"
					}
					return <div className="col-xs-4 col-md-4"><button style={style} className="btn btn-default btn-block" onClick={onClick}>{this.props.text}</button></div>
				}
			}); */

			var AgileBoardStockTaker = React.createClass({
				getInitialState: function() {
					return {
						issueId: "",
						selectedIssueId: null,
						issuesChanged: [],
						mode: "login",
						projectData: null
					}
				},
				doneClicked: function() {
					this.setState({
						selectedIssueId: this.state.issueId,
						issueId: ""
					});
				},
				completeClicked: function() {
					console.log("asdf");
					this.setState({
						mode: "changed"
					});
				},
				numberClicked: function(number) {
					this.setState({
						issueId: this.state.issueId + number
					})
				},
				issueChanged: function(data) {
					this.setState({
						issuesChanged: this.state.issuesChanged.concat(data)
					});
				},
				moreClicked: function() {
					this.setState({
						mode: "input"
					});
				},
				login: function(url, username, password) {
					this.state.url = url;
					this.state.username = username;
					this.state.password = password;
					this.setState({
						url: url,
						username: username,
						password: password,
						mode: "loggedIn"
					});
					this.selectProject(80);
					// getDataWithJSON(function(data) {
					// 	var projects = [];
					// 	data.views.forEach(function(view) {
					// 		console.log(view.name, view.id, view.key, view);
					// 		projects.push({name: view.name, id: view.id, key: view.key})
					// 	});
					// 	this.setState({projectData: projects});
					// }.bind(this), username, password, url + "/rest/greenhopper/1.0/rapidviews/viewsData.json");
				},
				saveLoginDetails: function() {

				},
				selectProject: function(projectId) {
					getDataWithJSON(function(projectData) {
						var key = projectData.issues[0].key.substr(0,projectData.issues[0].key.indexOf("-"));
						//project.key = key;
						getDataWithJSON(function(data) {
							if (data && data.issues) {
								console.log("HOORAY!", arguments);
								this.saveLoginDetails();
								data.issues.forEach(function(issue) {
									issueHandler.addIssue({id: issue.key, column: issue.statusName});
								});
								// this.setState({
								// 	selectedProject: project,
								// 	mode: "input"
								// })
							}
						}.bind(this), this.state.username, this.state.password, this.state.url + "/rest/greenhopper/1.0/xboard/plan/backlog/data.json?rapidViewId=" + projectId);

					}.bind(this), this.state.username, this.state.password, this.state.url + "/rest/greenhopper/1.0/xboard/plan/backlog/data.json?rapidViewId=" + projectId);
				},
				render: function() {
					var style = {
						margin: "20px",
						minHeight: "50%",
						maxHeight: "50%"
					}
					if (this.state.mode === "login") {
						return <div className="container"><LoginPanel login={this.login}></LoginPanel></div>
					} else if (this.state.mode === "loggedIn") {
						return <div className="container">Hooray!</div>
					} else {
						return <div className="container">
							Something went terribly wrong...
						</div>
					}
				}
			});

			React.renderComponent(<AgileBoardStockTaker/>, document.getElementById('main'));

			function IssueHandler() {
				this.issues = [];
			}

			IssueHandler.prototype.addIssue = function(issue) {
				this.issues.push(issue);
			}

			IssueHandler.prototype.getIssue = function(issueId) {
				for (var i=0; i < this.issues.length; i++) {
					var issue = this.issues[i];
					if (issue.id.match(/\d+/)[0] === issueId) {
						return issue;
					}
				}
				return null;
			}

			var issueHandler = new IssueHandler();
			getDataWithJSON = function(callback, username, password, requestUrl) {
				var xhr = new XMLHttpRequest();
				xhr.open("GET", "https://cors-anywhere.herokuapp.com/" + requestUrl)
				if (this.username !== "") {
					this.setAuthorizationHeader(xhr, username, password);
				}
				xhr.setRequestHeader("x-requested-with", "love");
				xhr.send();
				xhr.onload = function(response) {
					if (this.status === 401) {
						callback(this.status);
					} else {
						var data = JSON.parse(response.target.response);
						callback(data);
					}
				}
			};

			setAuthorizationHeader = function(xhr, username, password) {
				var authHeader = "Basic "+btoa(username + ":" + password);
				xhr.setRequestHeader("Authorization", authHeader);
			}

		</script>
	</body>
</html>
<html>
	<head>
		<title>Agile Board Stock Taker</title>
		<script src="lib/react.js"></script>
		<script src="lib/jsxTransformer.js"></script>
		<script src="lib/jquery-1.11.1.min.js"></script>
		<script src="lib/bootstrap-3.2.0-dist/js/bootstrap.min.js"></script>
		<link href="lib/bootstrap-3.2.0-dist/css/bootstrap.css" rel="stylesheet">
		<style>
			.number-btn {
				width: 30%
			}
		</style>
	</head>
	<body>
		<div id="main"></div>
		<script type="text/jsx">
			/** @jsx React.DOM */
			var ChangedIssuePanel = React.createClass({
				render: function() {
					return <div>{this.props.issue.issueId} - {this.props.issue.columnName}</div>
				}
			});

			var ChangedIssuesPanel = React.createClass({
				render: function() {
					if (this.props.issues) {

						var issues = [];
						this.props.issues.forEach(function(issue) {
							issues.push(<ChangedIssuePanel issue={issue}></ChangedIssuePanel>);
						});
						return <div>{issues}</div>
					} else {
						return <div></div>
					}
				}
			});

			var IdInput = React.createClass({
				render: function() {
					return <input value={this.props.issueId}/>
				}
			});

			var ColumnLi = React.createClass({
				onClick: function() {
					this.props.onClick(this.props.name);
				},
				render: function() {
					return <li><a href="#" onClick={this.onClick}>{this.props.name}</a></li>
				}
			});

			var ColumnSelector = React.createClass({
				getInitialState: function() {
					console.log("!!!");
					return {selectedText: this.props.selected}
				},
				onClick: function(text) {
					if (text !== this.state.selectedText) {
						this.setState({
							selectedText: text
						});
						this.props.columnChanged(text);
					}
				},
				render: function() {
					var optionStrings = ['Backlog', 'Development', 'Code Review', 'Awaiting Test', 'In Test', 'Done'];
					var options = [];
					optionStrings.forEach(function(optionString) {
						options.push(<ColumnLi onClick={this.onClick} name={optionString}></ColumnLi>);
					 }.bind(this));
					return <span className="btn-group">
						<button type="button" className="btn btn-default dropdown-toggle" data-toggle="dropdown">
							{this.state.selectedText}<span className="caret"></span>
						</button>
						<ul className="dropdown-menu" role="menu">
							{options}
						</ul>
					</span>
				}
			});

			var IssuePanel = React.createClass({
				getInitialState: function() {
					console.log("XXX");
					return {

					};
				},
				columnChanged: function(columnName) {
					this.props.issueChanged({issueId: this.props.issueId, columnName: columnName});
				},
				render: function() {
					if (this.props.issueId) {
						var issue = issueHandler.getIssue(this.props.issueId);
						if (issue) {
							return <div className="panel panel-default">
								<div className="panel-body">
									<span>{issue.id}</span>
									<ColumnSelector columnChanged={this.columnChanged} selected={issue.column}></ColumnSelector>
								</div>
							</div>
						} else {
							return <div></div>
						}
					} else {
						return <div></div>
					}
				}
			});

			var IssuesPanel = React.createClass({
				getInitialState: function() {
					console.log("YYY");
					return {};
				},
				render: function() {
					return <div><IssuePanel issueChanged={this.props.issueChanged} issueId={this.props.issueId}></IssuePanel></div>
				}
			});

			var NumberDiv = React.createClass({
				doneClicked: function() {
					this.props.doneClicked();
				},
				completeClicked: function() {
					this.props.completeClicked();
				},
				numberClicked:function(number) {
					this.props.numberClicked(number);
				},
				render: function() {
					var numberRows = [];
					for (var i=0; i < 3; i++) {
						var buttons = [];
						for (var j=1; j < 4; j++) {
							buttons.push(<NumberButton buttonClicked={this.numberClicked} text={i*3+j}></NumberButton>);
						}
						numberRows.push(<ButtonRow buttonClicked={this.numberClicked} buttons={buttons}></ButtonRow>);
					}
					var buttons = [];
					var zero = 0;
					buttons.push(<NumberButton buttonClicked={this.numberClicked} text={zero}></NumberButton>);
					buttons.push(<NumberButton buttonClicked={this.doneClicked} text="Done"></NumberButton>);
					buttons.push(<NumberButton buttonClicked={this.completeClicked} text="Complete"></NumberButton>);
					numberRows.push(<ButtonRow buttons={buttons}></ButtonRow>);

					return <div><div className="row">{numberRows}</div></div>;
				}
			});

			var ButtonRow = React.createClass({
				render: function() {

					return <div className="row">{this.props.buttons}</div>
				}
			});

			var NumberButton = React.createClass({
				render: function() {
					var onClick = function() {
						this.props.buttonClicked(this.props.text);
					}.bind(this);
					return <div className="col-md-4"><button className="btn btn-default btn-block" onClick={onClick}>{this.props.text}</button></div>
				}
			});

			var AgileBoardStockTaker = React.createClass({
				getInitialState: function() {
					return {
						issueId: "",
						selectedIssueId: null,
						issuesChanged: [],
						showChanged: false
					}
				},
				doneClicked: function() {
					this.setState({
						selectedIssueId: this.state.issueId,
						issueId: ""
					});
				},
				completeClicked: function() {
					console.log("asdf");
					this.setState({
						showChanged: true
					});
				},
				numberClicked: function(number) {
					this.setState({
						issueId: this.state.issueId + number
					})
				},
				issueChanged: function(data) {
					this.setState({
						issuesChanged: this.state.issuesChanged.concat(data)
					});
				},
				moreClicked: function() {
					this.setState({
						showChanged: false
					});
				},
				render: function() {
					if (!this.state.showChanged) {
						return <div className="container">
							<IssuesPanel issueChanged={this.issueChanged} issueId={this.state.selectedIssueId}></IssuesPanel>
							<IdInput issueId={this.state.issueId}></IdInput>
							<NumberDiv numberClicked={this.numberClicked} completeClicked={this.completeClicked} doneClicked={this.doneClicked}></NumberDiv>
						</div>;
					} else {
						return <div className="container">
							<ChangedIssuesPanel issues={this.state.issuesChanged}></ChangedIssuesPanel>
							<NumberButton buttonClicked={this.moreClicked} text="Add More"></NumberButton>
						</div>
					}
				}
			});

			React.renderComponent(<AgileBoardStockTaker/>, document.getElementById('main'));

			function IssueHandler() {
				this.issues = [];
			}

			IssueHandler.prototype.addIssue = function(issue) {
				this.issues.push(issue);
			}

			IssueHandler.prototype.getIssue = function(issueId) {
				for (var i=0; i < this.issues.length; i++) {
					var issue = this.issues[i];
					if (issue.id.match(/\d+/)[0] === issueId) {
						return issue;
					}
				}
				return null;
			}

			var issueHandler = new IssueHandler();
			issueHandler.addIssue({id: "CSAN-111", column: "In Development"});
			issueHandler.addIssue({id: "CSAN-112", column: "Awaiting QA"});
			issueHandler.addIssue({id: "CSAN-113", column: "Code Review"});
			issueHandler.addIssue({id: "CSAN-114", column: "Backlog"});
			issueHandler.addIssue({id: "CSAN-115", column: "In Test"});
		</script>
	</body>
</html>